/**
 * Date对象格式化
 * @param format (年:yyyy; 月:MM; 日:dd; 时:hh; 分:mm; 秒:ss)
 * @returns {*}
 */
Date.prototype.format = function(format){
    let o = {
        'M+' : this.getMonth()+1, //month
        'd+' : this.getDate(), //day
        'h+' : this.getHours(), //hour
        'm+' : this.getMinutes(), //minute
        's+' : this.getSeconds(), //second
        'q+' : Math.floor((this.getMonth()+3)/3), //quarter
        'S' : this.getMilliseconds() //millisecond
    };
    if(/(y+)/.test(format)) {
        format = format.replace(RegExp.$1, (this.getFullYear()+'').substr(4 - RegExp.$1.length));
    }
    for(let k in o) {
        if(new RegExp('('+ k +')').test(format)) {
            format = format.replace(RegExp.$1, RegExp.$1.length===1 ? o[''+k] : ('00'+ o[''+k]).substr((''+ o[''+k]).length));
        }
    }
    return format;
};
/**
 * 字符串格式化
 * 范例: '{0}a%sb{1}c%sd{0}'.format('0', '1', '2', '3') = 0a2b1c3d0
 * @returns {string}
 */
String.prototype.format = function(){
    let result = this;
    let len = arguments == null ? 0 : arguments.length;
    if(len > 0){
        let i = 0;
        for(; i<len; i++){
            let reg = '{' + i + '}', value = arguments[i];
            if(result.indexOf(reg) >= 0) {
                while (result.indexOf(reg) >= 0) {
                    result = result.replace(reg, value);
                }
            }
            else{
                break;
            }
        }
        for(; i<len; i++){
            result = result.replace('%s', arguments[i]);
        }
    }
    return '' + result;
};
String.prototype.trim = function(){
    return this.replace(/^\s+|\s+$/gm,'');
};
String.prototype.htmlEncode = function(){
    return this.replace(/&/g,"&amp;").replace(/["]/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
};
String.prototype.htmlDecode = function(){
    return this.replace(/&gt;/g,">").replace(/&lt;/g,"<").replace(/&quot;/g,'"').replace(/&amp;/g,"&");
};

let $utils = function(){
    return {
        /**
         * 是否整型
         * @param str
         * @returns {boolean}
         */
        is_int: function(str){
            return /^\d+$/.test('' + str);
        },
        /**
         * 是否数值型, 包含小数
         * @param str
         * @returns {boolean}
         */
        is_number: function(str){
            return /^[\d.]+$/.test('' + str);
        },
        /**
         * 值
         * @param val
         * @returns {string}
         */
        get_str: function(val){
            return val === undefined || val == null ? '' : ('' + val).trim();
        },
        /**
         * 转换为整型
         * @param val
         * @param default_value 默认值:0
         * @returns {*}
         */
        get_int: function(val, default_value){
            if(typeof val == 'boolean'){
                return val ? 1 : 0;
            }
            return isNaN(parseInt(val)) ? (default_value || 0) : parseInt(val);
        },
        /**
         * 整型字符串
         * @param str
         * @returns {string}
         */
        get_int_str: function(str){
            return ('' + str).replace(/\D/g, '');
        },
        /**
         * 转换为浮点型
         * @param str
         * @param default_value 默认值为0
         * @returns {*}
         */
        get_decimal: function(str, default_value){
            return isNaN(parseFloat(str)) ? (default_value || 0) : parseFloat(str);
        },
        /**
         * 浮点型格式化, 默认精度2位小数
         * @param str
         * @param fixed 精度
         * @returns {string}
         */
        get_decimal_str: function(str, fixed){
            return (isNaN(Number(str)) ? 0 : Number(str)).toFixed(fixed == null ? 2 : fixed);
        },
        get_bool: function(val){
            return this.get_int(val) !== 0;
        },
        /**
         * 金额格式化, 去除小数点尾数0
         * @param money
         * @returns {string}
         */
        get_short_money: function(money){
            if(isNaN(Number(money)) || Number(money) === 0){
                return '0';
            }
            let d_index = (''+money).indexOf('.');
            if(d_index < 0){
                return money;
            }
            money = '' + money;
            let sub_len = money.length - 1;
            for(let i=sub_len; i > d_index; i--){
                if(money.charAt(i) === '0'){
                    sub_len --;
                }
                else{
                    break;
                }
            }
            return Number(money).toFixed(sub_len - d_index);
        },
        /**
         * 根据key获取字典的值
         * @param dict
         * @param key
         * @param default_val
         * @returns {*}
         */
        get_dict_val: function(dict, key, default_val){
            return typeof dict == 'object' && this.get_str(key) in dict ? dict[this.get_str(key)] : (default_val || key);
        },
        /**
         * Date对象格式化
         * @param date  Date对象
         * @param formatter 格式化方式, 默认为 yyyy-MM-dd
         * @returns {string} 默认返回 yyyy-MM-dd
         */
        get_date_str: function(date, formatter){
            return (date || new Date()).format(formatter || 'yyyy-MM-dd');
        },
        /**
         * Date对象格式化为yyyyMMdd
         * @param date  Date对象
         * @returns {string} yyyyMMdd
         */
        get_date_short_str: function(date){
            return this.get_date_str(date, null).replace(/\D/g, '');
        },
        /**
         * Date对象格式化
         * @param date  Date对象
         * @param formatter 格式化方式, 默认为 yyyy-MM-dd hh:mm:ss
         * @returns {*|string} 默认返回 yyyy-MM-dd hh:mm:ss
         */
        get_time_str: function(date, formatter){
            return this.get_date_str(date, formatter || 'yyyy-MM-dd hh:mm:ss');
        },
        /**
         * Date对象格式化为yyyyMMddhhmmss
         * @param date  Date对象
         * @returns {string} yyyyMMddhhmmss
         */
        get_time_short_str: function(date){
            return this.get_time_str(date).replace(/\D/g, '');
        },
        /**
         * 时间/日期字符串转换Date对象
         * @param str   时间/日期字符串
         * @returns {Date} Date对象
         */
        time_str_to_date: function(str){
            str = this.get_str(str).replace(/\D/g, '');
            let date = new Date();
            if(str === ''){
                return date;
            }
            date.setDate(1);
            if(str.length > 3){
                date.setFullYear(parseInt(str.substr(0, 4)));
            }
            if(str.length > 5){
                date.setMonth(parseInt(str.substr(4, 2))-1);
            }
            if(str.length > 7){
                date.setDate(parseInt(str.substr(6, 2)));
            }
            if(str.length > 9){
                date.setHours(parseInt(str.substr(8, 2)));
            }
            if(str.length > 11){
                date.setMinutes(parseInt(str.substr(10, 2)));
            }
            if(str.length > 13){
                date.setSeconds(parseInt(str.substr(12, 2)));
            }
            return date;
        },
        /**
         * 时间字符串转换为毫秒数
         * @param time_str  时间字符串
         * @returns {number} 毫秒数
         */
        time_str_to_milliseconds: function(time_str) {
            return this.time_str_to_date(time_str).getTime();
        },
        /**
         * 日期字符串格式化
         * @param date_str  日期字符串
         * @returns {*|string} yyyy-MM-dd
         */
        date_str_formatter: function(date_str){
            return this.get_date_str(this.time_str_to_date(date_str), null);
        },
        /**
         * 时间字符串格式化
         * @param time_str  时间字符串
         * @returns {*|string} yyyy-MM-dd hh:mm:ss
         */
        time_str_formatter: function(time_str){
            return this.get_time_str(this.time_str_to_date(time_str));
        },
        /**
         * 秒数转换时间
         * @param seconds   秒数
         * @returns {string} hh:mm:ss
         */
        seconds_to_time: function(seconds){
            seconds = seconds < 0 ? 0 : seconds;
            let h = (''+(seconds/3600)).split('.')[0];
            let m = (''+((seconds%3600)/60)).split('.')[0];
            let s = (''+(seconds%60)).split('.')[0];
            return [(h<10?('0'+h):h), (m<10?('0'+m):m), (s<10?('0'+s):s)].join(':');
        },
        /**
         * 金额转换为中文大写
         * @param money
         * @returns {string}
         */
        money_zh_formatter: function(money){
            let str = '', strUnit = '仟佰拾亿仟佰拾万仟佰拾元角分';
            money = this.get_decimal(money).toFixed(2).replace(/\D/g, '');
            strUnit = strUnit.substr(strUnit.length - money.length);
            for (let i=0; i < money.length; i++){
                str += '零壹贰叁肆伍陆柒捌玖'.substr(this.get_int(money.substr(i, 1)), 1) + strUnit.substr(i, 1);
            }
            return str.replace(/零角零分$/, '整').replace(/零分$/, '').replace(/零[仟佰拾]/g, '零')
                .replace(/零{2,}/g, '零').replace(/零([亿|万])/g, '$1').replace(/零+元/, '元')
                .replace(/亿零{0,3}万/, '亿').replace(/^元/, '零元');
        },
        /**
         * 根据差异天数获取日期
         * @param date_str  日期/时间字符串, 空为当天
         * @param diff_days 差异天数(正数为加, 负数为减)
         * @returns {Date}
         */
        get_date_by_diff_days: function(date_str, diff_days){
            let date = this.time_str_to_date(date_str);
            diff_days = this.get_int(diff_days);
            if(diff_days !== 0) {
                date.setDate(date.getDate() + diff_days);
            }
            return date;
        },
        get_date_str_by_diff_days: function(date_str, diff_days, formatter){
            return this.get_date_str(this.get_date_by_diff_days(date_str, diff_days), formatter);
        },
        get_date_by_diff_month: function(date_str, diff_month){
            let date = this.time_str_to_date(date_str);
            diff_month = this.get_int(diff_month);
            if(diff_month !== 0){
                let d = date.getDate();
                date.setDate(1);
                date.setMonth(date.getMonth() + diff_month);
                date.setDate(d);
            }
            return date;
        },
        get_date_str_by_diff_month: function(date_str, diff_month, formatter){
            return this.get_date_str(this.get_date_by_diff_month(date_str, diff_month), formatter);
        },
        /**
         * 根据差异月份获取最小日期和最大日期
         * @param date_str 日期/时间字符串, 空为当月
         * @param diff_month 差异的月数(正数为加, 负数为减)
         * @returns {{date_min: Date, date_max: Date}} {最小日期对象, 最大日期对象}
         */
        get_month_date_range: function(date_str, diff_month){
            let date_min = this.time_str_to_date(date_str);
            date_min.setDate(1);
            diff_month = this.get_int(diff_month);
            if(diff_month !== 0){
                date_min.setMonth(date_min.getMonth() + diff_month);
            }
            let date_max = new Date();
            date_max.setFullYear(date_min.getFullYear());
            date_max.setDate(1);
            date_max.setMonth(date_min.getMonth() + 1);
            date_max.setDate(0);
            return {date_min: date_min, date_max: date_max};
        },
        /**
         * 根据差异周数获取最小日期和最大日期
         * @param date_str  日期/时间字符串, 空为当月
         * @param diff_week 差异的周数(正数为加, 负数为减)
         * @returns {{date_min: Date, date_max: Date}} {最小日期对象, 最大日期对象}
         */
        get_week_date_range: function(date_str, diff_week){
            let date_min = this.time_str_to_date(date_str);
            diff_week = this.get_int(diff_week);
            if(diff_week !== 0){
                date_min.setDate(date_min.getDate() + (diff_week * 7));
            }
            date_min.setDate(date_min.getDate() - (date_min.getDay() || 7) + 1);
            let date_max = new Date();
            date_max.setFullYear(date_min.getFullYear());
            date_max.setMonth(date_min.getMonth());
            date_max.setDate(date_min.getDate() + 6);
            return {date_min: date_min, date_max: date_max};
        },
        /**
         * 设置Cookie
         * @param key
         * @param value
         */
        set_cookie: function(key, value){
            let exp = new Date();
            exp.setTime(exp.getTime() + 30*24*60*60*1000);
            document.cookie = key + '=' + value + ';expires=' + exp.toGMTString();
        },
        /**
         * 获取Cookie
         * @param key
         * @returns {*}
         */
        get_cookie: function(key){
            let arr = document.cookie.match(new RegExp('(^| )'+key+'=([^;]*)(;|$)'));
            if(arr != null && arr.length > 1 && arr[2] != null){
                return arr[2];
            }
            return '';
        },
        /**
         * 删除Cookie
         * @param key
         */
        clear_cookie: function(key){
            this.set_cookie(key, '');
        },
        /**
         * 获取url上的所有参数
         * @returns {{}} 参数键值对对象
         */
        get_url_params: function(){
            let url = window.location.search;
            let params = {};
            if (url.indexOf('?') !== -1) {
                let str = url.substr(1);
                let ls = str.split('&');
                for (let i = 0; i < ls.length; i++) {
                    let _v = ls[i].split('=');
                    params[_v[0]] = unescape(_v[1]);
                }
            }
            return params;
        },
        /**
         * 根据key获取url上的参数
         * @param key
         * @returns {string}
         */
        get_url_param_by_key: function(key) {
            let reg = new RegExp('(^|&)'+ key +'=([^&]*)(&|$)');
            let r = window.location.search.substr(1).match(reg);
            if(r != null){
                return  unescape(r[2]);
            }
            return '';
        },
        /**
         * 根据字段生成下拉款(select)的选项(option)
         * @param dict  选项键值对字典
         * @returns {string} 选项(option)html代码
         */
        get_select_option_html_by_dict: function(dict){
            let result = '';
            if(dict == null){
                dict = {};
            }
            for(let key in dict){
                result += '<option value="%s">%s</option>'.format(''+key, dict[''+key]);
            }
            return result;
        },
        // 数组排序(升序)
        array_sort: function (arr, asc){
            if(asc == null){
                asc = true;
            }
            arr.sort(function(a, b){
                if(!asc){
                    return a-b;
                }
                return b-a;
            });
            return arr;
        },
        get_dict_len: function(dict){
            let len = 0;
            for(let _ in dict){
                len ++;
            }
            return len;
        },
        value_in_dict: function(dict, val){
            for(let k in dict){
                if(dict[''+k] === val){
                    return ''+k;
                }
            }
            return '';
        },
        fill_date_list: function (ls , date_min, date_max, date_key, asc){
            if(ls == null){
                ls = [];
            }
            let _curr_date = date_max || this.get_date_short_str();
            asc = this.get_bool(asc);
            if(asc && ls.length > 0){
                ls.reverse();
            }
            date_min = date_min || (ls.length>0 ? ls[ls.length-1][date_key] : this.get_date_str_by_diff_days(_curr_date, -1, 'yyyyMMdd'));
            let data = [];
            let tmp_val;
            for(let i=0; i<ls.length; i++){
                let val = ls[i];
                let count_date = val[date_key];
                while(this.get_int(_curr_date) > this.get_int(count_date)){
                    tmp_val = {};
                    tmp_val[date_key] = _curr_date;
                    data.push(tmp_val);
                    _curr_date = this.get_date_str_by_diff_days(_curr_date, -1, 'yyyyMMdd');
                }
                data.push(val);
                _curr_date = this.get_date_str_by_diff_days(count_date, -1, 'yyyyMMdd');
            }
            if(this.get_int(_curr_date) >= this.get_int(date_min)) {
                while (this.get_int(_curr_date) >= this.get_int(date_min)) {
                    tmp_val = {};
                    tmp_val[date_key] = _curr_date;
                    data.push(tmp_val);
                    _curr_date = this.get_date_str_by_diff_days(_curr_date, -1, 'yyyyMMdd');
                }
            }
            if(asc){
                data.reverse();
            }
            return data;
        },
        transfer_num_zh: function(num){
            let zh_ls = ['零', '一', '二', '三', '四', '五', '六', '七', '八', '九', '十'];
            return zh_ls[this.get_int(num)] || '';
        },
        /**
         * 删除 html 标记
         * @param str
         * @returns String
         */
        remove_html_tag: function (str){
            if(this.get_str(str) !== ""){
                str = str.replace(/<\/?[^>]*>/g,''); //去除HTML tag
                str = str.replace(/[ |]*\n/g,'\n'); //去除行尾空白
                //str = str.replace(/\n[\s| | ]*\r/g,'\n'); //去除多余空行
                str = str.replace(/&nbsp;/ig, ''); //去掉&nbsp;
            }
            return str;
        },
        /**
         * 格式化表单序列化
         * @param str
         * @returns {{}}
         */
        format_form_serialize_to_dict: function (str) {
            let ret = {};
            if(this.get_str(str) !== ""){
                let tmp_arr = str.split("&");
                for(let _ in tmp_arr){
                    let _v = tmp_arr[_].split("=");
                    ret[_v[0]] = _v[1] || '';
                }
            }
            return ret;
        },
        /** 获取鼠标点击位置，相对于窗口 **/
        get_mouse_pos:function (event) {
            let e = event || window.event;
            return {'x':e.clientX,'y':e.clientY}
        }
    }
}();
